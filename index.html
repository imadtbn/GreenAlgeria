<!doctype html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشروع الجزائر الخضراء — خريطة غرس الأشجار</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link id="leafletCSS" rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2gk0n1k6wQp0qv1X0rC3KkR0r5gqvFv9g/9m0+M=" crossorigin=""/>
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--muted:#6b7280;--accent:#1f8ef1}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, sans-serif;background:var(--bg);color:#0f172a}
    .app{display:grid;grid-template-columns:420px 1fr;gap:18px;height:100vh;padding:18px}
    .panel{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(12,18,36,0.06);padding:16px;overflow:auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    header h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    input.search{flex:1;padding:10px;border-radius:10px;border:1px solid #e6e9ef}
    button{background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:10px;cursor:pointer}
    #map{height:100%;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;text-align:right;border-bottom:1px solid #f1f3f6;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .row-action{display:flex;gap:8px;justify-content:flex-end}
    .badge{background:#eef6ff;color:#0b5ed7;padding:6px 8px;border-radius:999px;font-size:12px}
    .top-actions{display:flex;gap:8px;margin-top:8px}
    .file{border:1px dashed #e6e9ef;padding:10px;border-radius:10px;text-align:center;color:var(--muted)}
    @media (max-width:900px){.app{grid-template-columns:1fr;grid-template-rows:360px 1fr}} 
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <header>
        <div style="flex:1">
          <h1>مشروع الجزائر الخضراء</h1>
          <div style="font-size:13px;color:var(--muted)">صفحة خرائط لتحديد نقاط الغرس عبر 58 ولاية</div>
        </div>
        <div class="badge">25 أكتوبر 2025</div>
      </header><div class="controls">
    <input id="searchBox" class="search" placeholder="ابحث باسم الولاية أو اسم الموقع" />
    <button id="btnFind">بحث</button>
    <button id="btnLocate">أقرب موقع إلي</button>
  </div>

  <div class="top-actions">
    <label class="file">
      رفع ملف CSV
      <input id="fileInput" type="file" accept=".csv" style="display:none" />
    </label>
    <button id="btnReset">إعادة تعيين البيانات</button>
    <button id="btnExport">تصدير GeoJSON</button>
  </div>

  <div style="margin-top:12px">
    <strong>نقاط الغرس (عرض تجريبي)</strong>
    <div style="font-size:12px;color:var(--muted);margin-top:6px">يمكنك رفع ملف CSV يتضمن: name, wilaya, lat, lng, phone, open, close, status</div>
  </div>

  <table id="sitesTable">
    <thead>
      <tr><th>الولاية / الموقع</th><th>هاتف</th><th>المسافة</th></tr>
    </thead>
    <tbody></tbody>
  </table>

</aside>

<main class="panel" style="padding:0;">
  <div id="map"></div>
</main>

  </div>  <!-- Leaflet JS will be loaded dynamically if not present -->  <script>
    // Utilities
    function escapeHtml(text){ return (text||'').toString().replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Sample data
    const sampleSites = [
      {id:1, name:'موقع غرس الجزائر المركز', wilaya:'الجزائر', lat:36.7538, lng:3.0588, phone:'+213 21 00 00 01', open:'08:00', close:'17:00', status:'مؤكد'},
      {id:2, name:'موقع غرس وهران', wilaya:'وهران', lat:35.6971, lng:-0.6308, phone:'+213 41 00 00 02', open:'08:00', close:'17:00', status:'مؤكد'},
      {id:3, name:'موقع غرس قسنطينة', wilaya:'قسنطينة', lat:36.365, lng:6.6147, phone:'+213 31 00 00 03', open:'07:30', close:'16:30', status:'مؤكد'},
    ];

    // State
    let sites = sampleSites.slice();
    let markersLayer = null;
    let map = null;

    // Initialize Leaflet map when L is available
    function initMap(){
      if(typeof L === 'undefined'){
        console.error('Leaflet غير متاح أثناء initMap.');
        return;
      }

      // create map only once
      if(map) return;

      map = L.map('map', {zoomControl:true}).setView([28.0339, 1.6596], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
      renderMarkers();

      attachUIEvents();
    }

    // If Leaflet isn't loaded, load it dynamically then init
    function ensureLeafletAndInit(){
      if(typeof L !== 'undefined') return initMap();

      // load script dynamically
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      s.async = true;
      s.onload = ()=>{ console.log('Leaflet loaded dynamically'); initMap(); };
      s.onerror = ()=>{ alert('فشل تحميل مكتبة الخرائط (Leaflet). تأكد من اتصال الإنترنت أو أعد تحميل الصفحة.'); };
      document.head.appendChild(s);

      // as safety, try init after DOMContentLoaded in case script loaded earlier
      document.addEventListener('DOMContentLoaded', ()=>{ if(typeof L !== 'undefined') initMap(); });

      // timeout fallback
      setTimeout(()=>{ if(typeof L !== 'undefined') return; console.warn('Leaflet لم يُحمّل بعد بعد 5 ثوان.'); }, 5000);
    }

    // Render markers and table
    function renderMarkers(){
      if(!markersLayer || !map) return;
      markersLayer.clearLayers();
      sites.forEach(s => {
        const m = L.marker([s.lat,s.lng]).addTo(markersLayer);
        m.bindPopup(`<b>${escapeHtml(s.name)}</b><br>${escapeHtml(s.wilaya)}<br>الهاتف: ${escapeHtml(s.phone)}<br>الحالة: ${escapeHtml(s.status)}`);
        m.siteId = s.id;
      });
      renderTable();
    }

    function renderTable(userPos){
      const tbody = document.querySelector('#sitesTable tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      const computeDist = (lat1,lon1,lat2,lon2)=>{
        const toRad = v=>v*Math.PI/180;
        const R=6371;const dLat=toRad(lat2-lat1);const dLon=toRad(lon2-lon1);
        const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
        const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        return R*c;
      };

      let rows = sites.map(s=>{
        const dist = userPos? computeDist(userPos.lat,userPos.lng,s.lat,s.lng): null;
        return Object.assign({}, s, {distance: dist});
      });

      if(userPos) rows.sort((a,b)=> (a.distance||1e9)-(b.distance||1e9));

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.innerHTML = `<strong>${escapeHtml(r.wilaya)}</strong><br><small>${escapeHtml(r.name)}</small>`;
        const tdPhone = document.createElement('td');
        tdPhone.textContent = r.phone||'-';
        const tdDist = document.createElement('td');
        tdDist.textContent = r.distance? (r.distance.toFixed(2)+' km') : '-';
        tr.appendChild(tdName);tr.appendChild(tdPhone);tr.appendChild(tdDist);
        tr.style.cursor='pointer';
        tr.addEventListener('click', ()=>{
          if(map) map.setView([r.lat,r.lng],12);
          if(markersLayer) markersLayer.eachLayer(m=>{ if(m.siteId===r.id) m.openPopup(); });
        });
        tbody.appendChild(tr);
      });
    }

    // Nearest functions
    function haversine(lat1,lon1,lat2,lon2){ const toRad=v=>v*Math.PI/180; const R=6371; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
    function findNearest(lat,lng){ let min=null; let minD=1e9; sites.forEach(s=>{ const d = haversine(lat,lng,s.lat,s.lng); if(d<minD){minD=d;min=s;} }); return min; }

    // UI wiring (called once after map init)
    function attachUIEvents(){
      document.getElementById('btnFind').addEventListener('click', ()=>{
        const q = document.getElementById('searchBox').value.trim().toLowerCase();
        if(!q){ sites = sampleSites.slice(); renderMarkers(); return; }
        const filtered = sampleSites.filter(s => (s.name+ ' ' + s.wilaya).toLowerCase().includes(q));
        sites = filtered;
        renderMarkers();
      });

      document.getElementById('btnReset').addEventListener('click', ()=>{ sites = sampleSites.slice(); renderMarkers(); document.getElementById('searchBox').value=''; });

      document.getElementById('btnLocate').addEventListener('click', ()=>{
        if(!navigator.geolocation){ alert('المتصفح لا يدعم تحديد الموقع'); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
          const userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          if(window.userMarker && map) map.removeLayer(window.userMarker);
          if(map){ window.userMarker = L.circleMarker([userPos.lat,userPos.lng],{radius:8,fill:true}).addTo(map).bindPopup('أنت هنا').openPopup(); }
          const nearest = findNearest(userPos.lat,userPos.lng);
          if(nearest && map){ map.setView([nearest.lat,nearest.lng],12); markersLayer.eachLayer(m=>{ if(m.siteId===nearest.id) m.openPopup(); }); }
          renderTable(userPos);
        }, err=>{ alert('خطأ في الحصول على الموقع: '+err.message); });
      });

      // file import
      document.getElementById('fileInput').addEventListener('change', (e)=>{
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          const text = reader.result;
          const parsed = parseCSV(text);
          const imported = parsed.map((row,i)=>({id:1000+i,name:row.name||row.Name||row.NAME, wilaya:row.wilaya||row.Wilaya||row.wilayah||'', lat: parseFloat(row.lat||row.lat_deg||row.Lat) || 0, lng: parseFloat(row.lng||row.lon||row.Lng) || 0, phone: row.phone||'', open: row.open||'', close: row.close||'', status: row.status||''})).filter(r=>r.lat && r.lng);
          if(imported.length===0){ alert('لم يتم العثور على بيانات نقاط صالحة في الملف'); return; }
          sites = imported; renderMarkers(); if(map && markersLayer && markersLayer.getBounds && !markersLayer.getBounds().isValid()){} else if(map) map.fitBounds(markersLayer.getBounds(),{padding:[40,40]});
        };
        reader.readAsText(f, 'utf-8');
      });

      // export
      document.getElementById('btnExport').addEventListener('click', ()=>{
        const geo = {type:'FeatureCollection', features: sites.map(s=>({type:'Feature', properties:{id:s.id,name:s.name,wilaya:s.wilaya,phone:s.phone,open:s.open,close:s.close,status:s.status}, geometry:{type:'Point', coordinates:[s.lng,s.lat]}}))};
        const blob = new Blob([JSON.stringify(geo, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='algeria_greening_sites.geojson'; a.click(); URL.revokeObjectURL(url);
      });

      document.getElementById('searchBox').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('btnFind').click(); });
    }

    // CSV parser
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      if(lines.length===0) return [];
      const header = lines.shift().split(/,|;|\t/).map(h=>h.trim());
      return lines.map(line=>{ const cols = line.split(/,|;|\t/).map(c=>c.trim()); const obj = {}; header.forEach((h,i)=>obj[h]=cols[i]||''); return obj; });
    }

    // Start: ensure DOM loaded and Leaflet ready
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', ensureLeafletAndInit);
    } else {
      ensureLeafletAndInit();
    }

  </script></body>
</html>
